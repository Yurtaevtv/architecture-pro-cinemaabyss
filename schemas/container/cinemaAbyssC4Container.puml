@startuml
title Диаграмма контейнеров продукта КиноБездна

!include <C4/C4_Container>

Person(user, "Пользователь", "Пользователь стримингового сервиса")

System_Boundary(cinema_abyss, "Продукт КиноБездна") {

    Container(web_app, "Web Application", "Vue/React", "Веб-приложение")
    Container(mobile_spa, "Mobile App", "Vue/React", "Мобильное приложение")
    Container(smart_tv, "Smart TV App", "React", "Приложение для Smart TV")
    
    Container(api_gateway, "API Gateway", "YARP", "Единая точка входа для API")
    Container(ws_gateway, "WebSocket Gateway", ".Net + WebSocket", "Управление WebSocket соединениями")

    Container(user_api, "User API", ".Net", "Управление профилями пользователей")
    Container(payment_api, "Payment API", ".Net", "Обработка платежей")
    Container(subscription_api, "Subscription API", ".Net", "Управление подписками")
    Container(movie_api, "Movie API", ".Net", "Описание контента")
    Container(streaming_api, "Streaming API", ".Net", "Потоковая передача видео")
    Container(statistics_api, "Statistics API", ".Net", "Сбор аналитики просмотров")

    Container(message_bus, "Message Bus", "Kafka/RabbitMQ", "Асинхронная коммуникация")
    
    ContainerDb(user_db, "User Database", "PostgreSQL", "Данные пользователей и профилей")
    ContainerDb(payment_db, "Payment Database", "PostgreSQL", "Транзакции и платежи")
    ContainerDb(movie_db, "Movie Database", "PostgreSQL", "Метаданные контента")
    ContainerDb(subscription_db, "Subscription Database", "PostgreSQL", "Подписки и доступы")
    ContainerDb(statistics_db, "Statistics Database", "TimescaleDB", "Аналитика просмотров")
    
    Container(media_storage, "Media Storage", "S3/MinIO", "Хранилище видео и постеров")
}

System_Ext(payment_providers, "Платежные системы", "Yandex/Robokassa/Youpay")
System_Ext(recommendation_service, "Рекомендательная система", "ML-based recommendations")
System_Ext(external_streaming, "Стриминговый сервис", "Okko, Kinopoisk, etc")

' Пользовательские взаимодействия
Rel(user, web_app, "Смотрит фильмы", "HTTPS")
Rel(user, mobile_spa, "Смотрит на мобильном", "HTTPS")
Rel(user, smart_tv, "Смотрит на TV", "HTTPS")

' Фронтенд -> Бэкенд
Rel(web_app, api_gateway, "API запросы", "REST/HTTPS")
Rel(mobile_spa, api_gateway, "API запросы", "REST/HTTPS")


' Бэкенд -> Фронтенд 
Rel(ws_gateway, api_gateway, "События")
Rel(web_app, api_gateway,  "Получение события")
Rel(mobile_spa, api_gateway,   "Получение события")
Rel(smart_tv, api_gateway,   "Получение события")

' API Gateway маршрутизация
Rel(api_gateway, user_api, "Запросы профилей", "HTTP")
Rel(api_gateway, payment_api, "Платежные операции", "HTTP")
Rel(api_gateway, subscription_api, "Управление подписками", "HTTP")
Rel(api_gateway, movie_api, "Поиск контента", "HTTP")
Rel(api_gateway, streaming_api, "Получение stream URL", "HTTP")
Rel(api_gateway, statistics_api, "Отправка статистики", "HTTP")

' WebSocket Gateway
Rel(ws_gateway, message_bus, "Подписка на события")
Rel(message_bus, ws_gateway, "События по клиентам/оплатам/подпискам")

' Бизнес-логика сервисов
Rel(user_api, user_db, "Чтение/запись профилей", "SQL")
Rel(payment_api, payment_db, "Транзакции", "SQL")
Rel(payment_api, payment_providers, "Обработка платежей", "HTTPS")
Rel(subscription_api, subscription_db, "Управление подписками", "SQL")
Rel(movie_api, movie_db, "Метаданные контента", "SQL/NoSQL")
Rel(streaming_api, media_storage, "Получение видео", "S3 API")
Rel(streaming_api, external_streaming, "Запрос фильма стримингового сервиса")
Rel(statistics_api, statistics_db, "Сохранение метрик", "SQL")

' Асинхронная коммуникация
Rel(user_api, message_bus, "События профилей", "AMQP")
Rel(payment_api, message_bus, "События платежей", "AMQP")
Rel(subscription_api, message_bus, "События подписок", "AMQP")
Rel(movie_api, message_bus, "Обновления каталога", "AMQP")

' Подписки на события
Rel(message_bus, subscription_api, "Обновление статуса доступа", "AMQP")
Rel(message_bus, movie_api, "Изменения доступности", "AMQP")
Rel(message_bus, streaming_api, "Уведомления о контенте", "AMQP")

' Интеграции
Rel(statistics_api, recommendation_service, "История просмотров", "gRPC/HTTP")
Rel(recommendation_service, statistics_api, "Получение рекомендаций", "gRPC/HTTP")

' Прямые связи для производительности
Rel(streaming_api, subscription_api, "Проверка доступа", "gRPC")
Rel(movie_api, subscription_api, "Фильтрация по подписке", "gRPC")

@enduml